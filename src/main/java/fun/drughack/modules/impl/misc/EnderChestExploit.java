package fun.drughack.modules.impl.misc;

import fun.drughack.api.events.impl.EventKey;
import fun.drughack.api.events.impl.EventTick;
import fun.drughack.modules.api.Category;
import fun.drughack.modules.api.Module;
import fun.drughack.modules.settings.api.Bind;
import fun.drughack.modules.settings.impl.BindSetting;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.item.ItemStack;
import net.minecraft.screen.ScreenHandler;
import net.minecraft.screen.slot.SlotActionType;

public class EnderChestExploit extends Module {

    private final BindSetting saveKey = new BindSetting("Кнопка сейва", new Bind(-1, false));

    private boolean wantSave = false;
    private boolean fakeClosed = false;

    public EnderChestExploit() {
        // Если у вас есть Category.Player — замените Misc на Player
        super("EnderChestExploit", Category.Misc);
    }

    @EventHandler
    public void onKey(EventKey e) {
        if (e.getKey() == saveKey.getValue().getKey()) { // или saveKey.value().getKey()
            wantSave = true;
        }
    }

    @EventHandler
    public void onTick(EventTick e) {
        if (fullNullCheck()) {
            fakeClosed = false;
            wantSave = false;
            return;
        }

        ScreenHandler handler = mc.player.currentScreenHandler;
        if (handler != null && handler.slots.size() >= 27 && handler.getStacks().size() <= 63) {
            int chestSlots = handler.slots.size() - 36; // верхняя часть контейнера
            if (chestSlots == 27) { // стандартный эндер-сундук 3x9
                if (!fakeClosed && mc.currentScreen != null) {
                    mc.setScreen(null);
                    mc.mouse.lockCursor();
                    fakeClosed = true;
                }
                if (wantSave) {
                    wantSave = false;
                    fakeClosed = false;

                    for (int i = chestSlots; i < handler.slots.size(); i++) {
                        ItemStack stack = handler.getSlot(i).getStack();
                        if (!stack.isEmpty()) {
                            mc.interactionManager.clickSlot(handler.syncId, i, 0, SlotActionType.QUICK_MOVE, mc.player);
                        }
                    }
                }
                return;
            }
        }

        fakeClosed = false;
    }

    @Override
    public void onDisable() {
        super.onDisable();
        wantSave = false;
        fakeClosed = false;
    }
}